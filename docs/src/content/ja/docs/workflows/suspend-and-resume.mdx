---
title: "ワークフローの一時停止と再開 | Human-in-the-Loop | Mastra ドキュメント"
description: "Mastra のワークフローにおける一時停止と再開機能は、外部からの入力やリソースを待つ間に実行を一時停止することを可能にします。"
---

# ワークフローにおける一時停止と再開

複雑なワークフローでは、外部からの入力やリソースを待つ間に実行を一時停止する必要がよくあります。

Mastra の一時停止と再開機能を使うことで、ワークフローの実行を任意のステップで一時停止し、ワークフローのスナップショットをストレージに保存し、準備ができたときに保存されたスナップショットから実行を再開できます。
この一連のプロセスはすべて Mastra によって自動的に管理されます。設定やユーザーによる手動操作は一切必要ありません。

ワークフローのスナップショットをストレージに保存することで、ワークフローの状態がセッション、デプロイ、サーバーの再起動をまたいで永続的に保持されます。この永続性は、外部からの入力やリソースを待つ間に数分、数時間、あるいは数日間一時停止したままになる可能性があるワークフローにとって非常に重要です。

## サスペンド／レジュームを使用するタイミング

ワークフローをサスペンドする一般的なシナリオには、以下のようなものがあります。

- 人による承認や入力を待つ場合
- 外部APIリソースが利用可能になるまで一時停止する場合
- 後続のステップで必要となる追加データを収集する場合
- コストの高い処理をレート制限またはスロットリングする場合
- 外部トリガーによるイベント駆動型プロセスを処理する場合

## ステップを一時停止する方法

```typescript
// Create a step that handles human input with suspend/resume capabilities
const humanInputStep = createStep({
  id: "human-input",
  inputSchema: z.object({
    suggestions: z.array(z.string()),
    vacationDescription: z.string(),
  }),
  // Define the structure of data needed to resume the step
  resumeSchema: z.object({
    selection: z.string(),
  }),
  // Define the structure of data when suspending (empty in this case)
  suspendSchema: z.object({}),
  outputSchema: z.object({
    selection: z.string().describe("The selection of the user"),
    vacationDescription: z.string(),
  }),
  execute: async ({ inputData, resumeData, suspend }) => {
    // If no resume data is provided, suspend the step and wait for user input
    if (!resumeData?.selection) {
      await suspend({});
      return {
        selection: "",
        vacationDescription: inputData?.vacationDescription,
      };
    }
    return {
      selection: resumeData.selection,
      vacationDescription: inputData?.vacationDescription,
    };
  },
});
```

## ステップ実行の再開方法

### 一時停止状態の識別

ワークフローを実行する際、その状態は以下のいずれかになります：

- `running` - ワークフローが現在実行中
- `suspended` - ワークフローが一時停止中
- `success` - ワークフローが完了
- `failed` - ワークフローが失敗

状態が`suspended`の場合、ワークフローの`suspended`プロパティを確認することで、一時停止されているすべてのステップを識別できます。

```typescript
const run = counterWorkflow.createRun();
const result = await run.start({ inputData: { startValue: 0 } });

// Check if the workflow is in suspended state
if (result.status === "suspended") {
  // Resume the first suspended step with new data
  const resumedResults = await run.resume({
    step: result.suspended[0],
    resumeData: { newValue: 0 },
  });
}
```

この場合、一時停止として報告された最初のステップを再開するロジックとなっています。

`suspended`プロパティは`string[][]`型で、各配列は一時停止されたステップへのパスを表します。最初の要素はメインワークフローのステップIDです。そのステップ自体がワークフローである場合、2番目の要素はネストされたワークフローで一時停止されたステップIDとなります。さらにそれがワークフローである場合は、3番目の要素がネストされたワークフローで一時停止されたステップIDとなり、以降も同様です。

### 再開

```typescript
// Resume a suspended workflow with user input
const result = await workflowRun.resume({
  step: userInputStep, // or 'myStepId' as a string
  resumeData: {
    userSelection: "User's choice",
  },
});
```

ネストされた一時停止中のワークフローを再開するには：

```typescript
// Resume a suspended nested workflow with user input
const result = await workflowRun.resume({
  step: [nestedWorkflow, userInputStep], // or ['nestedWorkflowId', 'myStepId'] as a string array
  resumeData: {
    userSelection: "User's choice",
  },
});
```
